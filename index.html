<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Quiz — Mobile</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
    --brand:#2563eb; --brand2:#7c3aed; --ok:#10b981; --bad:#ef4444;
    --opt:#f8fafc; --opt-hover:#eff6ff;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#0b1020; --card:#0f172a; --ink:#e5e7eb; --muted:#93a4ba; --line:#1f2a44;
      --opt:#0b1326; --opt-hover:#111c34;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Arial,sans-serif;
    background:var(--bg); color:var(--ink);
  }

  /* Safe-area padding for notches */
  .safe { padding-left: max(16px, env(safe-area-inset-left));
          padding-right:max(16px, env(safe-area-inset-right)); }

  header{
    position:sticky; top:0; z-index:30;
    backdrop-filter:blur(8px) saturate(150%);
    background:linear-gradient(90deg,#e0f2fe, #e9d5ff);
    border-bottom:1px solid #dbeafe;
  }
  .head safe, .head { display:flex; align-items:center; justify-content:space-between }
  .head{ max-width:920px; margin:0 auto; padding:12px 0 }
  .title{ display:flex; gap:10px; align-items:center }
  .logo{ width:28px;height:28px;border-radius:8px;background:conic-gradient(from 210deg,#22d3ee,#3b82f6,#7c3aed); }
  h1{ font-size:16px; margin:0 }
  .chips{ display:flex; gap:6px; align-items:center }
  .chip{ font-size:11px; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#334155; border:1px solid #c7d2fe }
  @media (max-width:420px){ .chips{ display:none } }

  main{ max-width:920px; margin:14px auto 92px; } /* space for sticky footer */
  .card{
    background:var(--card); border:1px solid var(--line); border-radius:14px;
    box-shadow:0 8px 24px rgba(2,12,27,.05); padding:14px;
  }
  .screen{ display:none } .screen.active{ display:block }

  /* Meta row */
  .meta{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; margin-bottom:10px }
  .badges{ display:flex; gap:6px; align-items:center; flex-wrap:wrap }
  .badge{ font-size:12px; padding:6px 8px; border-radius:8px; border:1px solid var(--line); color:var(--muted) }
  .progress{ height:10px; background:#e6edf7; border-radius:999px; overflow:hidden }
  .bar{ height:100%; width:0; background:linear-gradient(90deg,#22d3ee,#3b82f6 50%,#7c3aed) }
  .pct{ font-size:12px; color:var(--muted); text-align:right }

  /* Question */
  .q{ font-size:18px; line-height:1.35; font-weight:700; margin:8px 0 6px }
  .sub{ color:var(--muted); font-size:13px; margin-bottom:6px }

  /* Options: mobile-first single column */
  .options{ display:grid; gap:10px; margin:12px 0 }
  @media (min-width:640px){ .options{ grid-template-columns:1fr 1fr } } /* becomes 2 cols on wider */
  .opt{
    background:var(--opt); border:1px solid var(--line); border-radius:12px;
    padding:14px; display:flex; gap:10px; align-items:flex-start; min-height:56px;
    font-size:16px; line-height:1.35; text-align:left; cursor:pointer;
    -webkit-tap-highlight-color: transparent; transition:background .12s, transform .04s;
  }
  .opt:hover{ background:var(--opt-hover) }
  .opt:active{ transform:scale(.996) }
  .key{ width:28px; height:28px; border-radius:8px; display:grid; place-items:center; font-weight:800; background:#e2e8f0; color:#111827 }
  @media (prefers-color-scheme: dark){ .key{ background:#1f2a44; color:#e5e7eb } }
  .opt.correct{ background:#ecfdf5; border-color:#bbf7d0 }
  .opt.wrong{ background:#fef2f2; border-color:#fecaca }
  .opt.correct .key{ background:#bbf7d0 }
  .opt.wrong .key{ background:#fecaca }
  .opt.disabled{ opacity:.95; pointer-events:none }

  /* Explanation as a mobile-friendly panel */
  .exp{
    display:none; margin-top:10px; border:1px dashed var(--line); border-radius:12px; padding:12px;
    background:rgba(2,12,27,.03);
  }
  .exp h3{ margin:0 0 6px; font-size:14px }
  .exp p{ margin:0; font-size:15px; white-space:pre-wrap }

  /* Sticky bottom controls: big tap targets */
  .controls{
    position:fixed; left:0; right:0; bottom:0; z-index:40;
    background:rgba(255,255,255,.92); border-top:1px solid var(--line); backdrop-filter:blur(10px);
  }
  @media (prefers-color-scheme: dark){
    .controls{ background:rgba(11,16,32,.9) }
  }
  .controls .inner{ max-width:920px; margin:0 auto; padding:10px 0 }
  .row{ display:flex; gap:10px; align-items:center; justify-content:space-between }
  .safeRow{ padding-left:max(16px, env(safe-area-inset-left)); padding-right:max(16px, env(safe-area-inset-right)); }
  button{
    font:inherit; padding:14px 16px; border-radius:12px; border:1px solid var(--line); background:var(--card); color:var(--ink);
    min-width:44px; min-height:44px; cursor:pointer;
  }
  .primary{
    background:linear-gradient(90deg,var(--brand),var(--brand2)); border:1px solid #1d4ed8; color:#fff;
    font-weight:700; letter-spacing:.2px;
  }
  .ghost{ background:transparent }
  button:disabled{ opacity:.55; cursor:not-allowed }

  /* Small toast */
  .toast{ position:fixed; top:10px; left:50%; transform:translateX(-50%); background:#111827; color:#fff;
          padding:8px 12px; border-radius:999px; font-size:13px; opacity:0; transition:opacity .2s, transform .2s }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(4px) }

  /* Reduce motion */
  @media (prefers-reduced-motion: reduce){
    .opt:active{ transform:none }
    .toast{ transition:none }
  }
</style>
</head>
<body>
  <header>
    <div class="head safe">
      <div class="title"><div class="logo" aria-hidden="true"></div><h1>My Quiz</h1></div>
      <div class="chips">
        <span class="chip">A/B/C/D</span>
        <span class="chip">Enter/→ Next</span>
        <span class="chip">← Prev</span>
      </div>
    </div>
  </header>

  <main class="safe">
    <!-- Intro -->
    <section id="intro" class="card screen active" aria-live="polite">
      <div style="font-weight:700;margin-bottom:6px">Loading questions…</div>
      <div style="color:var(--muted);font-size:14px">Place your JSON next to this file and make sure <code>QUESTIONS_URL</code> points to it.</div>
    </section>

    <!-- Quiz -->
    <section id="quiz" class="card screen" aria-labelledby="qLabel">
      <div class="meta">
        <div class="badges">
          <span id="metaIdx" class="badge">Q 1/1</span>
          <span id="metaScore" class="badge">Score 0</span>
          <span id="metaTime" class="badge">00:00</span>
        </div>
        <div class="pct" id="pct">0%</div>
      </div>
      <div class="progress" aria-hidden="true"><div id="bar" class="bar"></div></div>

      <h2 id="qLabel" class="q">—</h2>
      <div id="qSub" class="sub"></div>

      <div id="optBox" class="options" role="group" aria-label="Options"></div>

      <div id="exp" class="exp" aria-live="polite" aria-atomic="true">
        <h3>Explanation</h3>
        <p id="expText"></p>
      </div>
    </section>

    <!-- Result -->
    <section id="done" class="card screen">
      <div style="text-align:center;padding:16px 6px">
        <div style="color:var(--muted);font-size:14px">Finished</div>
        <div id="finalScore" style="font-size:32px;font-weight:800;margin:6px 0">—</div>
        <div id="finalMeta" style="color:var(--muted);font-size:14px">—</div>
        <div style="margin-top:12px;display:flex;gap:10px;justify-content:center">
          <button id="restart2" class="primary">Restart</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Sticky controls -->
  <nav class="controls">
    <div class="inner">
      <div class="row safeRow">
        <button id="prevBtn" class="ghost">◀ Prev</button>
        <div style="display:flex;gap:10px">
          <button id="restartBtn" class="ghost">Restart</button>
          <button id="nextBtn" class="primary" disabled>Next ▶</button>
        </div>
      </div>
    </div>
  </nav>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
/* ========= CONFIG ========= */
const QUESTIONS_URL = 'quiz_questions_from_pdf.json';

/* ========= DOM ========= */
const $ = s => document.querySelector(s);
const intro = $('#intro'), quiz = $('#quiz'), done = $('#done');
const metaIdx = $('#metaIdx'), metaScore = $('#metaScore'), metaTime = $('#metaTime');
const bar = $('#bar'), pct = $('#pct');
const qLabel = $('#qLabel'), qSub = $('#qSub'), optBox = $('#optBox');
const exp = $('#exp'), expText = $('#expText');
const prevBtn = $('#prevBtn'), nextBtn = $('#nextBtn'), restartBtn = $('#restartBtn'), restart2 = $('#restart2');
const toast = $('#toast');

/* ========= STATE ========= */
let BANK = [];
let i = 0, score = 0;
let startedAt = 0, ticker = null;

/* ========= LOAD ========= */
(async function boot(){
  try{
    const res = await fetch(QUESTIONS_URL, {cache:'no-store'});
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    const raw = await res.json();
    BANK = raw.map(normalize);
    startedAt = Date.now(); startTimer();
    show(quiz); render();
  }catch(err){
    intro.innerHTML = `
      <div style="color:#b91c1c;font-weight:700;margin-bottom:6px">Failed to load ${escapeHTML(QUESTIONS_URL)}</div>
      <div style="color:var(--muted)">Reason: ${escapeHTML(err.message||String(err))}</div>
    `;
  }
})();

function normalize(x, idx){
  const letters = ['A','B','C','D','E','F','G','H'];
  const q = String(x.question ?? '').trim();
  let options = [];
  if(Array.isArray(x.options)){
    options = x.options.map((t,n)=>({ key: letters[n]||String.fromCharCode(65+n), text: String(t??'').trim() }));
  }else if(x.options && typeof x.options==='object'){
    options = letters.filter(k=>x.options[k]!=null).map(k=>({ key:k, text:String(x.options[k]).trim() }));
  }
  const answerKey = String(x.answerKey ?? '').trim().toUpperCase();
  const explanation = String(x.explanation ?? '').trim();
  const correctIndex = options.findIndex(o => o.key.toUpperCase()===answerKey);
  return { id:x.id ?? idx+1, question:q, subtitle:String(x.subtitle??'').trim(),
           options, answerKey, correctIndex, explanation, userChoice:null, evaluated:false };
}

/* ========= RENDER ========= */
function render(){
  const total = BANK.length;
  if(!total){ qLabel.textContent='No questions found.'; optBox.innerHTML=''; nextBtn.disabled=true; return; }

  const q = BANK[i];

  // Meta & progress
  metaIdx.textContent = `Q ${i+1}/${total}`;
  metaScore.textContent = `Score ${score}`;
  const progress = Math.round((i/Math.max(1,total))*100);
  bar.style.width = progress + '%';
  pct.textContent = progress + '%';

  // Question
  qLabel.textContent = q.question || '—';
  qSub.textContent = q.subtitle || '';

  // Options (single column on phones)
  optBox.innerHTML = '';
  q.options.forEach(o=>{
    const btn = document.createElement('button');
    btn.className = 'opt';
    btn.setAttribute('data-key', o.key);
    btn.setAttribute('aria-label', `${o.key}. ${o.text}`);
    btn.innerHTML = `<span class="key">${o.key}</span><div class="txt">${escapeHTML(o.text)}</div>`;
    btn.addEventListener('click', ()=>choose(o.key));
    optBox.appendChild(btn);
  });

  if(q.evaluated){
    decorate(q);
    lockOptions(true);
    showExplanation(q);
    nextBtn.disabled = false;
  }else{
    lockOptions(false);
    hideExplanation();
    nextBtn.disabled = true;
  }
  prevBtn.disabled = (i===0);
}

function choose(key){
  const q = BANK[i];
  if(q.evaluated) return;
  q.userChoice = String(key||'').toUpperCase();
  q.evaluated = true;

  if(q.userChoice === q.answerKey){
    score++;
    metaScore.textContent = `Score ${score}`;
    ping('✅ Correct');
  }else{
    ping('✖ Wrong');
  }

  decorate(q);
  lockOptions(true);
  showExplanation(q);
  nextBtn.disabled = false;
  // Auto-scroll explanation into view on phones
  exp.scrollIntoView({block:'nearest', behavior:'smooth'});
}

function decorate(q){
  optBox.querySelectorAll('.opt').forEach(b=>{
    const k = (b.dataset.key||'').toUpperCase();
    if(k === q.answerKey) b.classList.add('correct');
    if(k === q.userChoice && q.userChoice !== q.answerKey) b.classList.add('wrong');
  });
}

function lockOptions(state){
  optBox.querySelectorAll('.opt').forEach(b=>{
    b.classList.toggle('disabled', !!state);
    b.disabled = !!state;
  });
}

function showExplanation(q){
  if(q.explanation){
    exp.style.display='block';
    expText.textContent = q.explanation;
  }else{
    hideExplanation();
  }
}
function hideExplanation(){ exp.style.display='none'; expText.textContent='' }

/* ========= NAV ========= */
function next(){
  if(i < BANK.length-1){ i++; render(); }
  else { finish(); }
}
function prev(){ if(i>0){ i--; render(); } }

function finish(){
  stopTimer();
  show(done);
  const total = BANK.length;
  const acc = total ? Math.round((score/total)*100) : 0;
  const t = formatTime((Date.now()-startedAt)/1000);
  $('#finalScore').textContent = `You scored ${score} / ${total}`;
  $('#finalMeta').textContent = `Accuracy ${acc}% • Time ${t}`;
}

function restart(){
  BANK = BANK.map(q=>({...q, userChoice:null, evaluated:false}));
  i = 0; score = 0;
  startedAt = Date.now(); restartTimer();
  show(quiz); render();
}

/* ========= UTIL ========= */
function show(el){ [intro,quiz,done].forEach(s=>s.classList.remove('active')); el.classList.add('active'); }
function escapeHTML(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function ping(msg){ toast.textContent = msg; toast.classList.add('show'); clearTimeout(ping._t); ping._t=setTimeout(()=>toast.classList.remove('show'), 900); }

/* Timer */
function startTimer(){ tick(); ticker=setInterval(tick,1000); }
function restartTimer(){ clearInterval(ticker); startTimer(); }
function stopTimer(){ clearInterval(ticker); }
function tick(){ const s=Math.max(0,Math.floor((Date.now()-startedAt)/1000)); metaTime.textContent = formatTime(s); }
function formatTime(s){ const m=Math.floor(s/60), sec=s%60; return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`; }

/* ========= EVENTS ========= */
nextBtn.addEventListener('click', next);
prevBtn.addEventListener('click', prev);
restartBtn.addEventListener('click', restart);
restart2?.addEventListener('click', restart);

window.addEventListener('keydown', (e)=>{
  const inQuiz = quiz.classList.contains('active');
  if(!inQuiz) return;
  const q = BANK[i];
  const key = e.key.toUpperCase();
  const letters=['A','B','C','D','E','F','G','H'];

  if(letters.includes(key) && !q?.evaluated){
    const btn = Array.from(optBox.querySelectorAll('.opt')).find(b => (b.dataset.key||'').toUpperCase()===key);
    if(btn) btn.click();
  }else if((e.key==='Enter'||e.key==='ArrowRight') && q?.evaluated){
    next();
  }else if(e.key==='ArrowLeft'){ prev(); }
});

/* Touch swipe: left = next (if answered), right = prev */
let touchX=null, touchY=null, swiped=false;
function touchStart(e){ const t=e.changedTouches[0]; touchX=t.clientX; touchY=t.clientY; swiped=false; }
function touchMove(e){
  if(touchX===null) return;
  const t=e.changedTouches[0], dx=t.clientX - touchX, dy=t.clientY - touchY;
  if(Math.abs(dx)>24 && Math.abs(dy)<32 && !swiped){
    swiped=true;
    if(dx<-24){ // swipe left
      const q=BANK[i]; if(q?.evaluated) next();
    }else if(dx>24){ prev(); }
  }
}
function touchEnd(){ touchX=null; touchY=null; swiped=false; }

document.addEventListener('touchstart', touchStart, {passive:true});
document.addEventListener('touchmove', touchMove, {passive:true});
document.addEventListener('touchend', touchEnd, {passive:true});
</script>
</body>
</html>